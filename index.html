<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Berra Sim√ºlat√∂r V3.0 Final</title>
    <style>
        :root { color-scheme: light; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #e5ddd5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; height: 100dvh; margin: 0;
            overscroll-behavior: none;
        }
        body.theme-tatli { background-color: #ffe6f1; }
        body.theme-sinirli { background-color: #7a0000; }
        body.theme-soguk { background-color: #d7ecff; }
        body.theme-ask { background-color: #ffd9ec; }
        body.theme-standart { background-color: #e5ddd5; }

        #chat-container {
            width: 100%; max-width: 480px; height: 100%; max-height: 95vh;
            background: #fff; box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            display: flex; flex-direction: column; border-radius: 16px; overflow: hidden;
        }
        @media (max-width: 480px) { #chat-container { height: 100dvh; border-radius: 0; } }

        #chat-header {
            background: linear-gradient(135deg, #075E54, #0b8263); color: white;
            padding: 12px 16px; display: flex; flex-direction: column; gap: 5px; flex-shrink: 0;
        }
        body.theme-sinirli #chat-header { background: linear-gradient(135deg, #b71c1c, #d32f2f); }
        #chat-header h2 { margin: 0; font-size: 1.2rem; }
        #status-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; font-size: 0.9rem; }
        #mood-status { font-weight: 600; }
        #meters { display: flex; gap: 6px; font-size: 0.75rem; opacity: 0.95; }
        #meters span { background: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 12px; }

        #chat-box {
            flex: 1; background: #f0e7df; padding: 15px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            scroll-behavior: smooth;
        }
        .message {
            max-width: 85%; padding: 8px 14px; border-radius: 18px; position: relative;
            font-size: 15px; line-height: 1.4; word-wrap: break-word; animation: fadeIn 0.2s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.bot { background: #fff; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message.user { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message.system {
            background-color: #ffebee; color: #c62828; align-self: center; text-align: center;
            font-weight: 500; font-size: 0.85rem; padding: 4px 12px; border-radius: 12px; opacity: 0.8; margin: 5px 0;
        }
        .typing-indicator {
            padding: 8px 12px; background: #fff; border-radius: 18px; border-bottom-left-radius: 4px;
            align-self: flex-start; display: flex; align-items: center; width: fit-content; margin-bottom: 5px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots span {
            width: 6px; height: 6px; background: #b6b5ba; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        #input-form {
            background: #f0f0f0; padding: 8px 10px; display: flex; align-items: center;
            gap: 8px; flex-shrink: 0; width: 100%;
        }
        #user-input {
            flex: 1; padding: 12px 15px; border: none; border-radius: 24px;
            outline: none; font-size: 16px; background: #fff; -webkit-appearance: none;
        }
        #send-btn {
            background: #075E54; color: white; border: none; width: 45px; height: 45px;
            border-radius: 50%; cursor: pointer; font-size: 20px; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.1s;
        }
        #send-btn:active { transform: scale(0.9); background-color: #0b8263; }
    </style>
</head>
<body class="theme-standart">
    <div id="chat-container">
        <div id="chat-header">
            <h2>Berra Sim√ºlat√∂r V3.0</h2>
            <div id="status-row">
                <span id="mood-status">Y√ºkleniyor...</span>
                <div id="meters">
                    <span id="patience-status">Sabƒ±r: --</span>
                    <span id="love-status">Sevgi: --</span>
                    <span id="trip-status">Trip: --</span>
                </div>
            </div>
        </div>
        
        <div id="chat-box"></div>

        <form id="input-form" autocomplete="off">
            <input type="text" id="user-input" placeholder="Mesaj yaz..." required>
            <button type="submit" id="send-btn">‚û§</button>
        </form>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            // --- AYARLAR ---
            const BASE_MOODS = ["TATLI", "SOƒûUK", "KISKAN√á", "ƒ∞LGƒ∞Lƒ∞", "ALAYCI"];
            const LOVE_THRESHOLD = 100, PATIENCE_START = 100, TRIP_THRESHOLD = 100;
            
            const moodThemes = {
                "TATLI":   { theme: "theme-tatli",   emojis: [":)", "ü•∞", "üòò", "üå∏", "üíñ"], headline: "Modu: TATLI üå∏" },
                "SOƒûUK":   { theme: "theme-soguk",   emojis: [".", "üëç", "ok"], headline: "Modu: SOƒûUK ‚ùÑÔ∏è" },
                "KISKAN√á": { theme: "theme-standart", emojis: ["üòí", "ü§®", "üëÄ", "üôÑ"], headline: "Modu: KISKAN√á üòí" },
                "ƒ∞LGƒ∞Lƒ∞":  { theme: "theme-standart", emojis: ["üòä", "ü§î", "‚ú®"], headline: "Modu: ƒ∞LGƒ∞Lƒ∞ ‚ú®" },
                "ALAYCI":  { theme: "theme-standart", emojis: ["üòè", "üòÇ", "ü§°"], headline: "Modu: ALAYCI üòè" },
                "Sƒ∞Nƒ∞RLƒ∞": { theme: "theme-sinirli",  emojis: ["üò°", "üí¢", "!"], headline: "Modu: Sƒ∞Nƒ∞RLƒ∞ üî•" },
                "A≈ûIK":    { theme: "theme-ask",      emojis: ["üíï", "üíó", "üòç", "üíò"], headline: "Modu: A≈ûIK üíñ" }
            };
            
            const K = {
                compliment: ["√∂zledim", "seviyorum", "g√ºzel", "tatlƒ±sƒ±n", "a≈ükƒ±m", "canƒ±m", "krali√ße", "harikasƒ±n", "prenses", "bir tanem"],
                anger: ["boydan", "foto", "salak", "aptal", "kes", "sus", "mal", "sie", "sg", "amk", "gerizekalƒ±"],
                apology: ["√∂z√ºr dilerim", "affet", "kusura bakma", "pi≈ümanƒ±m", "barƒ±≈üalƒ±m"],
                gossipNames: ["ay≈üe", "fatma", "mehmet", "ali", "ahmet", "merve", "can", "ece", "sude", "berk", "pelinsu"],
            };
            
            const RESPONSES = {
                gossip: ["Ay o ismi duyunca bile t√ºylerim diken diken oluyor!", "Onun hakkƒ±nda duyduklarƒ±mƒ± anlatsam dudaƒüƒ±n u√ßuklar.", "O √ßocuƒüun/kƒ±zƒ±n adƒ± √ßƒ±kmƒ±≈ü, bence hi√ß bula≈üma.", "Ge√ßen g√ºn yine bir rezillik √ßƒ±karmƒ±≈ü diyorlar, tam onluk hareket."],
                fortune: ["Yakƒ±n zamanda beklediƒüin o haber gelecek, i√ßini ferah tut.", "Kalbini yoran konuyu artƒ±k rafa kaldƒ±rman lazƒ±m, √∂n√ºne bak.", "Eline bir miktar para ge√ßecek ama geldiƒüi gibi harcama!", "Eski bir dosttan s√ºrpriz bir mesaj alabilirsin.", "A≈ük hayatƒ±nda kartlar yeniden daƒüƒ±tƒ±lƒ±yor, hazƒ±r ol."],
                trip: ["hmm", "peki", "ok", "...", "iyi", "tamam", "sen bilirsin", "üëç"],
                moods: {
                    "ALAYCI": [() => "Sen beni eƒülendirmek i√ßin mi g√∂nderildin?", () => `Cidden buna inanmamƒ± mƒ± bekliyorsun ${userName || 'canƒ±m'}?`, () => "Aferin, g√ºn√ºn ≈üakasƒ±nƒ± yaptƒ±n. G√ºlemedim ama."],
                    "KISKAN√á": [() => "Yine kimlerle konu≈üuyordun sen bakayƒ±m √ßevrimi√ßiydin?", () => `Bana yazmaya vakit bulabildin mi sonunda ${userName || 'beyefendi'}?`, () => "Telefonunu ver, bir ≈üey kontrol edeceƒüim."],
                    "TATLI": [() => "Ya sen ne tatlƒ± ≈üeysin √∂yle, yiyesim geldi üå∏", () => `Sen yazƒ±nca modum anƒ±nda d√ºzeliyor ${userName || 'balƒ±m'}.`, () => "Ke≈üke ≈üu an yanƒ±mda olsan da sarƒ±lsam ü§ó"],
                    "SOƒûUK": [() => "Hmm. Anladƒ±m.", () => "Peki, √∂yle olsun.", () => "≈ûu an bununla ilgilenmiyorum."],
                    "Sƒ∞Nƒ∞RLƒ∞": [() => "Sabrƒ±mƒ± ta≈üƒ±rma istersen, hi√ß iyi olmaz!", () => "≈ûu an hi√ß sƒ±rasƒ± deƒüil, git ba≈üƒ±mdan.", () => "Beni delirtmeye mi √ßalƒ±≈üƒ±yorsun sen bilerek mi yapƒ±yorsun?!"],
                    "A≈ûIK": [() => `Kalbim sadece senin i√ßin atƒ±yor sanki ${userName || 'a≈ükƒ±m'}.`, () => "Her mesajƒ±nda aptal gibi g√ºl√ºms√ºyorum telefona ü•∞", () => "Seni d√º≈ü√ºnmekten i≈ülerime odaklanamƒ±yorum."]
                },
                defaults: [() => "Baska anlat, dinliyorum.", () => `Ee daha daha nasƒ±lsƒ±n ${userName || 'bakalƒ±m'}?`, () => "Bug√ºn modum √ßok deƒüi≈üken, bir anƒ±m bir anƒ±mƒ± tutmuyor."]
            };

            // --- DURUM DEƒûƒ∞≈ûKENLERƒ∞ ---
            let userName = null;
            let baseMood = BASE_MOODS[Math.floor(Math.random() * BASE_MOODS.length)];
            let currentMood = baseMood;
            let status = { sabir: PATIENCE_START, love: 15, trip: 0, isTripMode: false };
            let gameState = { active: true, pendingRPS: false, pendingChoice: false };
            let typingEl = null;

            // --- DOM ELEMENTLERƒ∞ ---
            const UI = {
                chatBox: document.getElementById('chat-box'),
                inputForm: document.getElementById('input-form'),
                userInput: document.getElementById('user-input'),
                sendBtn: document.getElementById('send-btn'),
                mood: document.getElementById('mood-status'),
                patience: document.getElementById('patience-status'),
                love: document.getElementById('love-status'),
                trip: document.getElementById('trip-status')
            };

            // --- YARDIMCI FONKSƒ∞YONLAR ---
            function normalize(text) { return text?.toLocaleLowerCase('tr-TR').normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/ƒ±/g, 'i') || ""; }
            function hasKeyword(text, normalized, keywords) { return keywords.some(k => { const kNorm = normalize(k); return text.includes(k.toLocaleLowerCase('tr-TR')) || normalized.includes(kNorm); }); }
            
            function scrollToBottom() {
                UI.chatBox.scrollTop = UI.chatBox.scrollHeight;
            }

            function updateUI() {
                if (status.love >= LOVE_THRESHOLD) currentMood = "A≈ûIK";
                else if (status.sabir <= 25) currentMood = "Sƒ∞Nƒ∞RLƒ∞";
                else currentMood = baseMood;

                const info = moodThemes[currentMood] || moodThemes["TATLI"];
                document.body.className = info.theme;
                UI.mood.textContent = info.headline;
                UI.patience.textContent = `Sabƒ±r: ${Math.floor(status.sabir)}`;
                UI.love.textContent = `Sevgi: ${Math.floor(status.love)}`;
                UI.trip.textContent = status.isTripMode ? `TRƒ∞P: ${status.trip} ‚ö†Ô∏è` : `Trip: ${status.trip}`;
            }

            function addMessage(text, type) {
                const div = document.createElement('div');
                div.className = `message ${type}`;
                div.textContent = text;
                UI.chatBox.appendChild(div);
                scrollToBottom();
            }

            function showTyping() {
                if (typingEl) return;
                typingEl = document.createElement('div');
                typingEl.className = 'typing-indicator';
                typingEl.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>';
                UI.chatBox.appendChild(typingEl);
                scrollToBottom();
            }

            function hideTyping() {
                if (typingEl && typingEl.parentNode) {
                    typingEl.parentNode.removeChild(typingEl);
                }
                typingEl = null;
            }

            function respond(text, options = {}) {
                if (!gameState.active) return;
                const delay = options.delay || 1000 + Math.random() * 800;
                showTyping();
                setTimeout(() => {
                    hideTyping();
                    let finalText = options.raw ? text : appendEmoji(text);
                    addMessage(finalText, 'bot');
                    if (options.callback) options.callback();
                    updateUI();
                }, delay);
            }

            function appendEmoji(text) {
                if (status.isTripMode) return text;
                const info = moodThemes[currentMood];
                if (info?.emojis && Math.random() > 0.4) {
                    const emoji = info.emojis[Math.floor(Math.random() * info.emojis.length)];
                    return text.endsWith(emoji) ? text : `${text} ${emoji}`;
                }
                return text;
            }

            function adjustStatus(type, amount) {
                status[type] = Math.max(0, Math.min(type === 'love' ? 150 : 120, status[type] + amount));
                if (type === 'sabir' && amount < 0) {
                    status.trip = Math.min(TRIP_THRESHOLD, status.trip + Math.abs(amount/2));
                    if (status.trip >= 80 && !status.isTripMode) {
                        status.isTripMode = true;
                        addMessage("‚ö†Ô∏è Dƒ∞KKAT: Trip Modu A√ßƒ±ldƒ±!", 'system');
                    }
                }
                if (status.sabir <= 0) {
                    addMessage("BERRA'NIN SABRI T√úKENDƒ∞! ENGELLENDƒ∞Nƒ∞Z.", 'system');
                    gameState.active = false;
                    UI.userInput.disabled = true;
                    UI.userInput.placeholder = "Sohbet sonlandƒ±rƒ±ldƒ±.";
                }
                updateUI();
            }

            // --- OYUN MANTIƒûI ---
            function processInput(rawText) {
                const textLower = rawText.toLocaleLowerCase('tr-TR');
                const textNorm = normalize(rawText);

                // Sistem komutlarƒ±
                if (textLower === "√ßƒ±kƒ±≈ü") {
                    addMessage("Berra √ßevrimdƒ±≈üƒ± oldu.", 'system');
                    gameState.active = false;
                    UI.userInput.disabled = true;
                    return;
                }
                if (textLower === "sƒ±fƒ±rla" || textLower === "reset") {
                    window.location.reload(); // En temiz sƒ±fƒ±rlama
                    return;
                }

                if (!gameState.active) return;

                // 1. ƒ∞sim Kontrol√º
                if (!userName) {
                    let nameMatch = textLower.match(/(?:adƒ±m|ismim|benim\s+adƒ±m)\s+([a-zA-Zƒü√º≈üƒ±√∂√ß]+)/i);
                    if (!nameMatch && textLower.startsWith("ben ")) {
                         const possibleName = textLower.split(" ")[1];
                         if (!["geldim", "gidiyorum", "buradayƒ±m"].includes(possibleName)) {
                             nameMatch = [null, possibleName];
                         }
                    }
                    let nameCandidate = nameMatch ? nameMatch[1] : (rawText.split(' ').length === 1 ? rawText : null);

                    if (nameCandidate && nameCandidate.length > 2) {
                        userName = nameCandidate.charAt(0).toUpperCase() + nameCandidate.slice(1).toLocaleLowerCase('tr-TR');
                        adjustStatus('love', 10);
                        respond(`Memnun oldum ${userName}. Umarƒ±m beni sinir etmezsin.`);
                    } else {
                        respond("Bu bir isim mi emin olamadƒ±m. Bana d√ºzg√ºnce adƒ±nƒ± s√∂yle.");
                    }
                    return;
                }

                // 2. Bekleyen Oyunlar
                if (gameState.pendingRPS) {
                    const moves = ["ta≈ü", "kaƒüƒ±t", "makas"];
                    if (!moves.some(m => textLower.includes(m))) {
                        respond("Ta≈ü, kaƒüƒ±t ya da makas yazman lazƒ±m tatlƒ±m.");
                        return;
                    }
                    const botMove = moves[Math.floor(Math.random() * 3)];
                    let res = `Ben ${botMove} yaptƒ±m, `;
                    if (textLower.includes(botMove)) res += "berabere kaldƒ±k.";
                    else if ((textLower.includes("ta≈ü") && botMove==="makas") || 
                             (textLower.includes("kaƒüƒ±t") && botMove==="ta≈ü") || 
                             (textLower.includes("makas") && botMove==="kaƒüƒ±t")) {
                        res += "sen kazandƒ±n! ≈ûanslƒ± g√ºn√ºndesin."; adjustStatus('love', 5);
                    } else {
                        res += "ben kazandƒ±m! Ezik."; adjustStatus('sabir', 5);
                    }
                    gameState.pendingRPS = false;
                    respond(res);
                    return;
                }

                if (gameState.pendingChoice) {
                    if (textLower.includes("kƒ±rmƒ±zƒ±")) {
                        respond("Bence de kƒ±rmƒ±zƒ± bana √ßok yakƒ±≈üƒ±yor! Zevklisin."); adjustStatus('love', 10);
                    } else if (textLower.includes("mavi")) {
                        respond("Mavi mi? Hmm, belki denerim ama kƒ±rmƒ±zƒ± daha iyi sanki.");
                    } else {
                        respond("Mavi ya da kƒ±rmƒ±zƒ± dedim, ne dediƒüin anla≈üƒ±lmƒ±yor."); return;
                    }
                    gameState.pendingChoice = false;
                    return;
                }

                // 3. Trip Modu
                if (status.isTripMode) {
                    if (hasKeyword(textLower, textNorm, K.apology)) {
                        status.isTripMode = false; status.trip = 30; adjustStatus('sabir', 20);
                        respond(`Neyse, uzatmayalƒ±m. Bu seferlik affettim ${userName}.`);
                    } else {
                        respond(RESPONSES.trip[Math.floor(Math.random() * RESPONSES.trip.length)], { raw: true, delay: 600 });
                    }
                    return;
                }

                // 4. Anahtar Kelimeler
                if (hasKeyword(textLower, textNorm, K.anger)) {
                    adjustStatus('sabir', -25);
                    respond("Bana bak, √ºslubunu d√ºzelt kar≈üƒ±nda arkada≈üƒ±n yok!");
                    return;
                }
                if (hasKeyword(textLower, textNorm, K.compliment)) {
                    adjustStatus('love', 8); adjustStatus('trip', -10);
                    respond(["Ya ≈üƒ±martmasana beni", "Biliyorum harikayƒ±m ama duymak da g√ºzel.", "Sen de fena deƒüilsin hani."][Math.floor(Math.random()*3)]);
                    return;
                }
                if (hasKeyword(textLower, textNorm, ["ta≈ü kaƒüƒ±t", "oyun oyna"])) {
                    gameState.pendingRPS = true;
                    respond("Tamam, ta≈ü mƒ± kaƒüƒ±t mƒ± makas mƒ±? Se√ß bakalƒ±m.");
                    return;
                }
                if (hasKeyword(textLower, textNorm, ["falƒ±ma bak", "fal bak"])) {
                    respond(RESPONSES.fortune[Math.floor(Math.random() * RESPONSES.fortune.length)]);
                    return;
                }

                // 5. Dedikodu & Varsayƒ±lan
                const gossipName = K.gossipNames.find(n => textLower.includes(n));
                if (gossipName) {
                    adjustStatus('love', 5);
                    respond(`${RESPONSES.gossip[Math.floor(Math.random() * RESPONSES.gossip.length)]} (${gossipName.charAt(0).toUpperCase() + gossipName.slice(1)} i√ßin diyorum)`);
                    return;
                }

                const pool = RESPONSES.moods[currentMood] || RESPONSES.defaults;
                if (Math.random() < 0.15 && !gameState.pendingChoice) {
                    gameState.pendingChoice = true;
                    respond("Sence bug√ºn kƒ±rmƒ±zƒ± elbisemi mi giyeyim yoksa maviyi mi? (kƒ±rmƒ±zƒ±/mavi yaz)");
                } else {
                    respond(pool[Math.floor(Math.random() * pool.length)]());
                }
            }

            // --- OLAY Dƒ∞NLEYƒ∞Cƒ∞Sƒ∞ (TEK VE GARANTƒ∞) ---
            UI.inputForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const text = UI.userInput.value.trim();
                if (!text) return;

                // √ñnce UI g√ºncelle (Hƒ±z hissi i√ßin)
                UI.userInput.value = '';
                addMessage(text, 'user');
                
                // Sonra mantƒ±ƒüƒ± √ßalƒ±≈ütƒ±r (Hata olursa UI donmasƒ±n)
                try {
                    processInput(text);
                } catch (err) {
                    console.error("Oyun hatasƒ±:", err);
                    addMessage("Bir hata oldu, beynim yandƒ±. Tekrar dene.", 'system');
                }
            });

            // --- BA≈ûLAT ---
            updateUI();
            addMessage("--- Berra v3.0 Baƒülandƒ± ---", 'system');
            setTimeout(() => respond("Selam! Ben Berra. √ñnce adƒ±nƒ± baƒüƒ±≈üla bakalƒ±m?"), 800);
        });
    </script>
</body>
</html>
