<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Berra SimÃ¼latÃ¶r V2.7</title>
    <style>
        :root { color-scheme: light; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body {
            background-color: #e5ddd5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            display: flex; justify-content: center; align-items: center;
            height: 100vh; height: 100dvh; margin: 0;
            overscroll-behavior: none;
        }
        body.theme-tatli { background-color: #ffe6f1; }
        body.theme-sinirli { background-color: #7a0000; }
        body.theme-soguk { background-color: #d7ecff; }
        body.theme-ask { background-color: #ffd9ec; }
        body.theme-standart { background-color: #e5ddd5; }

        #chat-container {
            width: 100%; max-width: 480px; height: 100%; max-height: 95vh;
            background: #fff; box-shadow: 0 14px 28px rgba(0,0,0,0.25), 0 10px 10px rgba(0,0,0,0.22);
            display: flex; flex-direction: column; border-radius: 16px; overflow: hidden;
        }
        @media (max-width: 480px) { #chat-container { height: 100dvh; border-radius: 0; } }

        #chat-header {
            background: linear-gradient(135deg, #075E54, #0b8263); color: white;
            padding: 12px 16px; display: flex; flex-direction: column; gap: 5px; flex-shrink: 0;
        }
        body.theme-sinirli #chat-header { background: linear-gradient(135deg, #b71c1c, #d32f2f); }
        #chat-header h2 { margin: 0; font-size: 1.2rem; }
        #status-row { display: flex; justify-content: space-between; align-items: center; font-size: 0.9rem; }
        #mood-status { font-weight: 600; }
        #meters { display: flex; gap: 6px; font-size: 0.75rem; opacity: 0.95; }
        #meters span { background: rgba(0,0,0,0.2); padding: 3px 8px; border-radius: 12px; }

        #chat-box {
            flex: 1; background: #f0e7df; padding: 15px;
            overflow-y: auto; display: flex; flex-direction: column; gap: 8px;
            scroll-behavior: smooth; -webkit-overflow-scrolling: touch;
        }
        .message {
            max-width: 85%; padding: 8px 14px; border-radius: 18px; position: relative;
            font-size: 15px; line-height: 1.4; word-wrap: break-word; animation: fadeIn 0.15s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .message.bot { background: #fff; align-self: flex-start; border-bottom-left-radius: 4px; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message.user { background: #dcf8c6; align-self: flex-end; border-bottom-right-radius: 4px; box-shadow: 0 1px 1px rgba(0,0,0,0.05); }
        .message.system {
            background-color: #ffebee; color: #c62828; align-self: center; text-align: center;
            font-weight: 500; font-size: 0.85rem; padding: 4px 12px; border-radius: 12px; opacity: 0.8; margin: 5px 0;
        }
        .typing-indicator {
            padding: 8px 12px; background: #fff; border-radius: 18px; border-bottom-left-radius: 4px;
            align-self: flex-start; display: flex; align-items: center; width: fit-content; margin-bottom: 5px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.05);
        }
        .typing-dots { display: flex; gap: 4px; }
        .typing-dots span {
            width: 6px; height: 6px; background: #b6b5ba; border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
        .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        #input-form {
            background: #f0f0f0; padding: 8px 10px; display: flex; align-items: center;
            gap: 8px; flex-shrink: 0; width: 100%; z-index: 10;
        }
        #user-input {
            flex: 1; padding: 12px 15px; border: none; border-radius: 24px;
            outline: none; font-size: 16px; background: #fff; -webkit-appearance: none;
        }
        #send-btn {
            background: #075E54; color: white; border: none; width: 45px; height: 45px;
            border-radius: 50%; cursor: pointer; font-size: 20px; display: flex;
            align-items: center; justify-content: center; flex-shrink: 0; transition: transform 0.1s;
        }
        #send-btn:active { transform: scale(0.9); }
    </style>
</head>
<body class="theme-standart">
    <div id="chat-container">
        <div id="chat-header">
            <h2>Berra SimÃ¼latÃ¶r v2.7</h2>
            <div id="status-row">
                <span id="mood-status">BaÄŸlanÄ±yor...</span>
                <div id="meters">
                    <span id="patience-status">SabÄ±r: --</span>
                    <span id="love-status">Sevgi: --</span>
                    <span id="trip-status">Trip: --</span>
                </div>
            </div>
        </div>
        
        <div id="chat-box"></div>

        <form id="input-form" action="javascript:void(0);">
            <input type="text" id="user-input" placeholder="Mesaj yaz..." autocomplete="off" required>
            <button type="submit" id="send-btn">â¤</button>
        </form>
    </div>

    <script>
        const BASE_MOODS = ["TATLI", "SOÄUK", "KISKANÃ‡", "Ä°LGÄ°LÄ°", "ALAYCI"];
        const LOVE_THRESHOLD = 100, PATIENCE_START = 100, TRIP_THRESHOLD = 100;
        const moodThemes = {
            "TATLI":   { theme: "theme-tatli",   emojis: [":)", "ğŸ¥°", "ğŸ˜˜", "ğŸŒ¸", "ğŸ’–"], headline: "Modu: TATLI ğŸŒ¸" },
            "SOÄUK":   { theme: "theme-soguk",   emojis: [".", "ğŸ‘", "ok"], headline: "Modu: SOÄUK â„ï¸" },
            "KISKANÃ‡": { theme: "theme-standart", emojis: ["ğŸ˜’", "ğŸ¤¨", "ğŸ‘€", "ğŸ™„"], headline: "Modu: KISKANÃ‡ ğŸ˜’" },
            "Ä°LGÄ°LÄ°":  { theme: "theme-standart", emojis: ["ğŸ˜Š", "ğŸ¤”", "âœ¨"], headline: "Modu: Ä°LGÄ°LÄ° âœ¨" },
            "ALAYCI":  { theme: "theme-standart", emojis: ["ğŸ˜", "ğŸ˜‚", "ğŸ¤¡"], headline: "Modu: ALAYCI ğŸ˜" },
            "SÄ°NÄ°RLÄ°": { theme: "theme-sinirli",  emojis: ["ğŸ˜¡", "ğŸ’¢", "!"], headline: "Modu: SÄ°NÄ°RLÄ° ğŸ”¥" },
            "AÅIK":    { theme: "theme-ask",      emojis: ["ğŸ’•", "ğŸ’—", "ğŸ˜", "ğŸ’˜"], headline: "Modu: AÅIK ğŸ’–" }
        };
        const K = {
            compliment: ["Ã¶zledim", "seviyorum", "gÃ¼zel", "tatlÄ±sÄ±n", "aÅŸkÄ±m", "canÄ±m", "kraliÃ§e", "harikasÄ±n", "prenses", "bir tanem"],
            anger: ["boydan", "foto", "salak", "aptal", "kes", "sus", "mal", "sie", "sg", "amk"],
            apology: ["Ã¶zÃ¼r dilerim", "affet", "kusura bakma", "piÅŸmanÄ±m", "barÄ±ÅŸalÄ±m"],
            gossipNames: ["ayÅŸe", "fatma", "mehmet", "ali", "ahmet", "merve", "can", "ece", "sude", "berk", "pelinsu"],
        };
        const RESPONSES = {
            gossip: ["Ay o ismi duyunca bile tÃ¼ylerim diken diken oluyor!", "Onun hakkÄ±nda duyduklarÄ±mÄ± anlatsam dudaÄŸÄ±n uÃ§uklar.", "O Ã§ocuÄŸun/kÄ±zÄ±n adÄ± Ã§Ä±kmÄ±ÅŸ, bence hiÃ§ bulaÅŸma.", "GeÃ§en gÃ¼n yine bir rezillik Ã§Ä±karmÄ±ÅŸ diyorlar, tam onluk hareket."],
            fortune: ["YakÄ±n zamanda beklediÄŸin o haber gelecek, iÃ§ini ferah tut.", "Kalbini yoran konuyu artÄ±k rafa kaldÄ±rman lazÄ±m, Ã¶nÃ¼ne bak.", "Eline bir miktar para geÃ§ecek ama geldiÄŸi gibi harcama!", "Eski bir dosttan sÃ¼rpriz bir mesaj alabilirsin.", "AÅŸk hayatÄ±nda kartlar yeniden daÄŸÄ±tÄ±lÄ±yor, hazÄ±r ol."],
            trip: ["hmm", "peki", "ok", "...", "iyi", "tamam", "sen bilirsin", "ğŸ‘"],
            moods: {
                "ALAYCI": [() => "Sen beni eÄŸlendirmek iÃ§in mi gÃ¶nderildin?", () => `Cidden buna inanmamÄ± mÄ± bekliyorsun ${userName || 'canÄ±m'}?`, () => "Aferin, gÃ¼nÃ¼n ÅŸakasÄ±nÄ± yaptÄ±n. GÃ¼lemedim ama."],
                "KISKANÃ‡": [() => "Yine kimlerle konuÅŸuyordun sen bakayÄ±m Ã§evrimiÃ§iydin?", () => `Bana yazmaya vakit bulabildin mi sonunda ${userName || 'beyefendi'}?`, () => "Telefonunu ver, bir ÅŸey kontrol edeceÄŸim."],
                "TATLI": [() => "Ya sen ne tatlÄ± ÅŸeysin Ã¶yle, yiyesim geldi ğŸŒ¸", () => `Sen yazÄ±nca modum anÄ±nda dÃ¼zeliyor ${userName || 'balÄ±m'}.`, () => "KeÅŸke ÅŸu an yanÄ±mda olsan da sarÄ±lsam ğŸ¤—"],
                "SOÄUK": [() => "Hmm. AnladÄ±m.", () => "Peki, Ã¶yle olsun.", () => "Åu an bununla ilgilenmiyorum."],
                "SÄ°NÄ°RLÄ°": [() => "SabrÄ±mÄ± taÅŸÄ±rma istersen, hiÃ§ iyi olmaz!", () => "Åu an hiÃ§ sÄ±rasÄ± deÄŸil, git baÅŸÄ±mdan.", () => "Beni delirtmeye mi Ã§alÄ±ÅŸÄ±yorsun sen bilerek mi yapÄ±yorsun?!"],
                "AÅIK": [() => `Kalbim sadece senin iÃ§in atÄ±yor sanki ${userName || 'aÅŸkÄ±m'}.`, () => "Her mesajÄ±nda aptal gibi gÃ¼lÃ¼msÃ¼yorum telefona ğŸ¥°", () => "Seni dÃ¼ÅŸÃ¼nmekten iÅŸlerime odaklanamÄ±yorum."]
            },
            defaults: [() => "Baska anlat, dinliyorum.", () => `Ee daha daha nasÄ±lsÄ±n ${userName || 'bakalÄ±m'}?`, () => "BugÃ¼n modum Ã§ok deÄŸiÅŸken, bir anÄ±m bir anÄ±mÄ± tutmuyor."]
        };

        let userName = null, baseMood = BASE_MOODS[Math.floor(Math.random() * BASE_MOODS.length)], currentMood = baseMood;
        let status = { sabir: PATIENCE_START, love: 15, trip: 0, isTripMode: false };
        let gameState = { active: true, pendingRPS: false, pendingChoice: false };

        const UI = {
            chatBox: document.getElementById('chat-box'),
            inputForm: document.getElementById('input-form'),
            userInput: document.getElementById('user-input'),
            sendBtn: document.getElementById('send-btn'),
            mood: document.getElementById('mood-status'),
            patience: document.getElementById('patience-status'),
            love: document.getElementById('love-status'),
            trip: document.getElementById('trip-status')
        };

        initGame();
        function initGame() {
            userName = null; baseMood = BASE_MOODS[Math.floor(Math.random() * BASE_MOODS.length)]; currentMood = baseMood;
            status = { sabir: PATIENCE_START, love: 15, trip: 0, isTripMode: false };
            gameState = { active: true, pendingRPS: false, pendingChoice: false };
            UI.chatBox.innerHTML = ''; UI.userInput.disabled = false; UI.sendBtn.disabled = false; UI.userInput.placeholder = "Mesaj yaz...";
            updateUI(); addSystemMessage("--- Berra v2.7 BaÄŸlandÄ± ---");
            setTimeout(() => respond("Selam! Ben Berra. Ã–nce adÄ±nÄ± baÄŸÄ±ÅŸla bakalÄ±m?"), 800);
        }

        function normalize(text) { return text?.toLocaleLowerCase('tr-TR').normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/Ä±/g, 'i') || ""; }
        function hasKeyword(text, normalized, keywords) { return keywords.some(k => { const kNorm = normalize(k); return text.includes(k.toLocaleLowerCase('tr-TR')) || normalized.includes(kNorm); }); }
        function updateUI() {
            if (status.love >= LOVE_THRESHOLD) currentMood = "AÅIK"; else if (status.sabir <= 25) currentMood = "SÄ°NÄ°RLÄ°"; else currentMood = baseMood;
            const info = moodThemes[currentMood] || moodThemes["TATLI"]; document.body.className = info.theme;
            UI.mood.textContent = info.headline; UI.patience.textContent = `SabÄ±r: ${Math.floor(status.sabir)}`;
            UI.love.textContent = `Sevgi: ${Math.floor(status.love)}`; UI.trip.textContent = status.isTripMode ? `TRÄ°P: ${status.trip} âš ï¸` : `Trip: ${status.trip}`;
        }
        function addMessage(text, type) {
            const div = document.createElement('div'); div.className = `message ${type}`; div.textContent = text;
            UI.chatBox.appendChild(div);
            scrollToBottom();
        }
        const addBotMessage = (text) => addMessage(text, 'bot'), addUserMessage = (text) => addMessage(text, 'user'), addSystemMessage = (text) => addMessage(text, 'system');
        
        // GÃœÃ‡LENDÄ°RÄ°LMÄ°Å KAYDIRMA
        function scrollToBottom() {
            UI.chatBox.scrollTop = UI.chatBox.scrollHeight;
            requestAnimationFrame(() => UI.chatBox.scrollTop = UI.chatBox.scrollHeight);
        }

        function respond(text, options = {}) {
            if (!gameState.active) return;
            const delay = options.delay || 1000 + Math.random() * 800; showTyping();
            setTimeout(() => { hideTyping(); addBotMessage(options.raw ? text : appendEmoji(text)); if (options.callback) options.callback(); updateUI(); }, delay);
        }
        let typingEl = null;
        function showTyping() { hideTyping(); typingEl = document.createElement('div'); typingEl.className = 'typing-indicator'; typingEl.innerHTML = '<div class="typing-dots"><span></span><span></span><span></span></div>'; UI.chatBox.appendChild(typingEl); scrollToBottom(); }
        function hideTyping() { if (typingEl?.parentNode) typingEl.remove(); }
        function appendEmoji(text) {
            if (status.isTripMode) return text; const info = moodThemes[currentMood];
            if (info?.emojis && Math.random() > 0.4) { const emoji = info.emojis[Math.floor(Math.random() * info.emojis.length)]; return text.endsWith(emoji) ? text : `${text} ${emoji}`; } return text;
        }
        function adjustStatus(type, amount) {
            status[type] = Math.max(0, Math.min(type === 'love' ? 150 : 120, status[type] + amount));
            if (type === 'sabir' && amount < 0) { status.trip = Math.min(TRIP_THRESHOLD, status.trip + Math.abs(amount/2)); if (status.trip >= 80 && !status.isTripMode) { status.isTripMode = true; addSystemMessage("âš ï¸ DÄ°KKAT: Trip Modu AÃ§Ä±ldÄ±!"); } }
            if (status.sabir <= 0) { addSystemMessage("BERRA'NIN SABRI TÃœKENDÄ°! ENGELLENDÄ°NÄ°Z."); gameState.active = false; UI.userInput.disabled = true; UI.userInput.placeholder = "Sohbet sonlandÄ±rÄ±ldÄ±."; } updateUI();
        }

        // --- GARANTÄ°LÄ° MESAJ Ä°ÅLEYÄ°CÄ° ---
        UI.inputForm.addEventListener('submit', (e) => {
            e.preventDefault(); // Sayfa yenilenmesini durdur
            const rawText = UI.userInput.value.trim();
            if (!rawText) return;

            // 1. Ã–nce mesajÄ± ekrana bas (Gecikme olmamasÄ± iÃ§in en Ã¼stte)
            addUserMessage(rawText);
            UI.userInput.value = '';
            // UI.userInput.focus(); // Mobilde klavye sorunu yaparsa bu satÄ±rÄ± silin

            // 2. Sonra mantÄ±ÄŸÄ± Ã§alÄ±ÅŸtÄ±r
            const textLower = rawText.toLocaleLowerCase('tr-TR'), textNorm = normalize(rawText);
            if (textLower === "Ã§Ä±kÄ±ÅŸ") { addSystemMessage("Berra Ã§evrimdÄ±ÅŸÄ± oldu."); gameState.active = false; UI.userInput.disabled = true; return; }
            if (textLower === "sÄ±fÄ±rla" || textLower === "reset") { initGame(); return; }
            if (!gameState.active) return;

            if (!userName) {
                let nameMatch = textLower.match(/(?:adÄ±m|ismim|benim\s+adÄ±m)\s+([a-zA-ZÄŸÃ¼ÅŸÄ±Ã¶Ã§]+)/i);
                if (!nameMatch && textLower.startsWith("ben ")) { const possibleName = textLower.split(" ")[1]; if (!["geldim", "gidiyorum", "buradayÄ±m"].includes(possibleName)) nameMatch = [null, possibleName]; }
                let nameCandidate = nameMatch ? nameMatch[1] : (rawText.split(' ').length === 1 ? rawText : null);
                if (nameCandidate && nameCandidate.length > 2) { userName = nameCandidate.charAt(0).toUpperCase() + nameCandidate.slice(1).toLocaleLowerCase('tr-TR'); adjustStatus('love', 10); respond(`Memnun oldum ${userName}. UmarÄ±m beni sinir etmezsin.`); }
                else { respond("Bu bir isim mi emin olamadÄ±m. Bana dÃ¼zgÃ¼nce adÄ±nÄ± sÃ¶yle."); } return;
            }
            if (gameState.pendingRPS) { handleRPS(textLower); return; }
            if (gameState.pendingChoice) { handleChoice(textLower); return; }
            if (status.isTripMode) {
                if (hasKeyword(textLower, textNorm, K.apology)) { status.isTripMode = false; status.trip = 30; adjustStatus('sabir', 20); respond(`Neyse, uzatmayalÄ±m. Bu seferlik affettim ${userName}.`); }
                else { respond(RESPONSES.trip[Math.floor(Math.random() * RESPONSES.trip.length)], { raw: true, delay: 600 }); } return;
            }
            if (hasKeyword(textLower, textNorm, K.anger)) { adjustStatus('sabir', -25); respond("Bana bak, Ã¼slubunu dÃ¼zelt karÅŸÄ±nda arkadaÅŸÄ±n yok!"); return; }
            if (hasKeyword(textLower, textNorm, K.compliment)) { adjustStatus('love', 8); adjustStatus('trip', -10); respond(["Ya ÅŸÄ±martmasana beni", "Biliyorum harikayÄ±m ama duymak da gÃ¼zel.", "Sen de fena deÄŸilsin hani."][Math.floor(Math.random()*3)]); return; }
            if (hasKeyword(textLower, textNorm, ["taÅŸ kaÄŸÄ±t", "oyun oyna"])) { gameState.pendingRPS = true; respond("Tamam, taÅŸ mÄ± kaÄŸÄ±t mÄ± makas mÄ±? SeÃ§ bakalÄ±m."); return; }
            if (hasKeyword(textLower, textNorm, ["falÄ±ma bak", "fal bak"])) { respond(RESPONSES.fortune[Math.floor(Math.random() * RESPONSES.fortune.length)]); return; }
            const gossipName = K.gossipNames.find(n => textLower.includes(n));
            if (gossipName) { adjustStatus('love', 5); respond(`${RESPONSES.gossip[Math.floor(Math.random() * RESPONSES.gossip.length)]} (${gossipName.charAt(0).toUpperCase() + gossipName.slice(1)} iÃ§in diyorum)`); return; }
            const pool = RESPONSES.moods[currentMood] || RESPONSES.defaults;
            if (Math.random() < 0.15 && !gameState.pendingChoice) { gameState.pendingChoice = true; respond("Sence bugÃ¼n kÄ±rmÄ±zÄ± elbisemi mi giyeyim yoksa maviyi mi? (kÄ±rmÄ±zÄ±/mavi yaz)"); }
            else { respond(pool[Math.floor(Math.random() * pool.length)]()); }
        });

        function handleRPS(move) {
            if (!["taÅŸ", "kaÄŸÄ±t", "makas"].some(m => move.includes(m))) { respond("TaÅŸ, kaÄŸÄ±t ya da makas yazman lazÄ±m tatlÄ±m."); return; }
            const bot = ["taÅŸ", "kaÄŸÄ±t", "makas"][Math.floor(Math.random()*3)];
            let res = `Ben ${bot} yaptÄ±m, `;
            if (move.includes(bot)) res += "berabere kaldÄ±k."; else if ((move.includes("taÅŸ") && bot==="makas") || (move.includes("kaÄŸÄ±t") && bot==="taÅŸ") || (move.includes("makas") && bot==="kaÄŸÄ±t")) { res += "sen kazandÄ±n! ÅanslÄ± gÃ¼nÃ¼ndesin."; adjustStatus('love', 5); } else { res += "ben kazandÄ±m! Ezik."; adjustStatus('sabir', 5); }
            gameState.pendingRPS = false; respond(res);
        }
        function handleChoice(text) {
            if (text.includes("kÄ±rmÄ±zÄ±")) { respond("Bence de kÄ±rmÄ±zÄ± bana Ã§ok yakÄ±ÅŸÄ±yor! Zevklisin."); adjustStatus('love', 10); }
            else if (text.includes("mavi")) { respond("Mavi mi? Hmm, belki denerim ama kÄ±rmÄ±zÄ± daha iyi sanki."); }
            else { respond("Mavi ya da kÄ±rmÄ±zÄ± dedim, ne dediÄŸin anlaÅŸÄ±lmÄ±yor."); return; }
            gameState.pendingChoice = false;
        }
    </script>
</body>
</html>
